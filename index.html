<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MKA Pro - Cloud Business</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/10149/10149458.png">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; margin: 0; color: white; padding-bottom: 50px; }
        .container { background: white; color: black; margin: 10px; padding: 15px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        input, select, button { padding: 12px; margin: 5px 0; border-radius: 8px; border: 1px solid #cbd5e1; width: 100%; box-sizing: border-box; font-size: 15px; }
        button { cursor: pointer; background: #0f172a; color: white; font-weight: bold; border: none; }
        .card { background: #f8fafc; padding: 12px; margin: 8px 0; border-radius: 8px; border-left: 5px solid #0f172a; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .hidden { display: none !important; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .admin-box { border: 2px solid #ef4444; padding: 15px; border-radius: 12px; margin-top: 20px; background: #fff1f2; }
        .change-box { background: #e0f2fe; border: 2px solid #0284c7; padding: 12px; border-radius: 12px; margin: 15px 0; color: #0369a1; }
        .label-sm { font-size: 11px; font-weight: bold; color: #64748b; margin-top: 5px; display: block; }
        .btn-del { background: #dc2626; padding: 5px 10px; font-size: 12px; width: auto; }
        .flex-row { display: flex; justify-content: space-between; align-items: center; }
        .taux-badge { background: #facc15; color: black; padding: 4px 12px; border-radius: 15px; font-weight: bold; font-size: 13px; }
    </style>
</head>
<body>

    <h1 style="text-align:center; padding: 10px;">MKA Pro : Cloud Edition</h1>

    <div class="container">
        <div id="loginSection">
            <h2>Acc√®s S√©curis√©</h2>
            <input type="password" id="pinInput" placeholder="Code PIN">
            <button onclick="login()" style="width:100%">Ouvrir la session</button>
        </div>

        <div id="appSection" class="hidden">
            <div class="flex-row">
                <button onclick="logout()" style="background:#64748b;">D√©connexion</button>
                <div style="text-align:right">
                    <strong>Tiroir Cash :</strong> <br>
                    <span id="caisseUSD">0</span> $ | <span id="caisseCDF">0</span> FC
                </div>
            </div>

            <div style="text-align: center; margin: 15px 0;">
                <span class="taux-badge">Taux : 1$ = <span id="displayTaux">...</span> FC</span>
            </div>

            <h3>Soldes SIM & Stocks</h3>
            <div id="operatorBalances"></div>

            <div class="change-box">
                <h3 style="margin:0 0 10px 0; text-align:center">üîÑ Change & Transfert</h3>
                
                <label class="label-sm">SOURCE (D'o√π sort l'argent ?)</label>
                <select id="srcWallet"></select>
                
                <div class="grid-2">
                    <div>
                        <label class="label-sm">MONTANT SORTIE</label>
                        <input type="number" id="srcAmt" placeholder="0.00" oninput="calcDest()">
                    </div>
                    <div>
                        <label class="label-sm">DEVISE</label>
                        <select id="srcCurr" onchange="calcDest()">
                            <option value="USD">USD</option>
                            <option value="CDF">CDF</option>
                        </select>
                    </div>
                </div>

                <label class="label-sm">DESTINATION (O√π va l'argent ?)</label>
                <select id="destWallet"></select>

                <div class="grid-2">
                    <div>
                        <label class="label-sm">MONTANT RE√áU</label>
                        <input type="number" id="destAmt" style="background:#f1f5f9" readonly>
                    </div>
                    <div>
                        <label class="label-sm">DEVISE RE√áUE</label>
                        <select id="destCurr" onchange="calcDest()">
                            <option value="CDF">CDF</option>
                            <option value="USD">USD</option>
                        </select>
                    </div>
                </div>

                <button onclick="executeGlobalChange()" style="background:#0284c7; width:100%; margin-top:10px; font-size:16px">CONFIRMER LE TRANSFERT</button>
            </div>

            <hr>
            <h2>Nouvelle Op√©ration</h2>
            <div class="grid-2">
                <select id="operatorSelect"></select>
                <select id="typeSelect"></select>
            </div>
            
            <div class="grid-2">
                <input type="number" id="amount" placeholder="Montant">
                <select id="currency"><option value="USD">USD</option><option value="CDF">CDF</option></select>
            </div>

            <label class="label-sm">PAIEMENT CLIENT</label>
            <select id="paymentSource" onchange="togglePaymentSim()">
                <option value="cash">Paiement CASH</option>
                <option value="virtuel">Paiement SIM</option>
            </select>
            
            <div id="paymentSimContainer" class="hidden" style="background: #f0fdf4; padding: 10px; border-radius: 8px;">
                <select id="paymentSimSelect"></select>
            </div>

            <input type="text" id="motif" placeholder="R√©f√©rence / Client">
            <button onclick="addTransaction()" style="background: #10b981; width: 100%; margin-top: 10px;">VALIDER L'OP√âRATION</button>

            <hr>
            <div id="history"></div>
            <button id="btnVoirTout" onclick="toggleFullHistory()" style="background:#64748b; width:100%;">Historique complet</button>

            <div id="adminSection" class="hidden">
                <div class="admin-box">
                    <h2 style="color:#b91c1c; margin-top:0">üîß Administration</h2>
                    
                    <div style="background: white; padding:10px; border-radius:8px; margin-bottom:15px;">
                        <h4>üí∞ Configuration Taux</h4>
                        <input type="number" id="newTaux" placeholder="Nouveau taux (ex: 2800)">
                        <button onclick="updateTaux()" style="background:#0f172a; width:100%">Mettre √† jour</button>
                    </div>

                    <div style="background: white; padding:10px; border-radius:8px; margin-bottom:15px;">
                        <h4>‚ûï Nouvelle SIM</h4>
                        <input type="text" id="newOpName" placeholder="Nom SIM">
                        <div class="grid-3">
                            <input type="number" id="initUSD" placeholder="USD">
                            <input type="number" id="initCDF" placeholder="CDF">
                            <input type="number" id="initStock" placeholder="Stock">
                        </div>
                        <button onclick="addOperator()" style="background:#b91c1c; width:100%">Cr√©er</button>
                    </div>

                    <div style="background: white; padding:10px; border-radius:8px; margin-bottom:15px;">
                        <h4>‚öôÔ∏è Cr√©er Type d'Op√©ration</h4>
                        <input type="text" id="newTypeName" placeholder="Nom">
                        <div class="grid-3">
                            <div><label class="label-sm">SIM</label>
                            <select id="impO"><option value="0">0</option><option value="1">+</option><option value="-1">-</option></select></div>
                            <div><label class="label-sm">Stock</label>
                            <select id="impS"><option value="0">0</option><option value="1">+</option><option value="-1">-</option></select></div>
                            <div><label class="label-sm">Caisse</label>
                            <select id="impC"><option value="0">0</option><option value="1">+</option><option value="-1">-</option></select></div>
                        </div>
                        <button onclick="addType()" style="background:#b91c1c; width:100%; margin-top:10px">Ajouter</button>
                    </div>

                    <div id="adminOpList"></div>
                    <hr>
                    <div id="adminTypeList"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDSK9sIPu8fvGebZQG9EdHBhlf7nl8Dmzs",
            authDomain: "mka-mobile-money.firebaseapp.com",
            databaseURL: "https://mka-mobile-money-default-rtdb.firebaseio.com",
            projectId: "mka-mobile-money"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let data = { caisse: {USD:0, CDF:0}, operators: [], types: [], transactions: [], taux: 2800 };
        let showFull = false;

        onValue(ref(db, 'mka_data'), (snap) => {
            if(snap.val()) {
                data = snap.val();
                if(!data.taux) data.taux = 2800;
                if(!data.operators) data.operators = [];
                render();
            }
        });

        const saveData = () => set(ref(db, 'mka_data'), data);

        window.login = () => {
            const pin = document.getElementById("pinInput").value;
            if(pin === "1234") window.role = "admin";
            else if(pin === "0000") window.role = "employe";
            else return alert("PIN Incorrect");
            document.getElementById("loginSection").classList.add("hidden");
            document.getElementById("appSection").classList.remove("hidden");
            if(window.role === "admin") document.getElementById("adminSection").classList.remove("hidden");
            render();
        };

        window.logout = () => location.reload();

        window.updateTaux = () => {
            const t = parseFloat(document.getElementById("newTaux").value);
            if(t > 0) { data.taux = t; saveData(); alert("Taux mis √† jour"); }
        };

        // CALCUL AUTOMATIQUE DU CHANGE DANS LE MODULE DE TRANSFERT
        window.calcDest = () => {
            const amt = parseFloat(document.getElementById("srcAmt").value) || 0;
            const sCurr = document.getElementById("srcCurr").value;
            const dCurr = document.getElementById("destCurr").value;
            let result = amt;

            if(sCurr === "USD" && dCurr === "CDF") result = amt * data.taux;
            else if(sCurr === "CDF" && dCurr === "USD") result = amt / data.taux;

            document.getElementById("destAmt").value = result.toFixed(sCurr === dCurr ? 0 : 2);
        };

        // EXECUTION DU TRANSFERT / CHANGE UNIVERSEL
        window.executeGlobalChange = () => {
            const srcIdx = document.getElementById("srcWallet").value; // "caisse" ou index SIM
            const destIdx = document.getElementById("destWallet").value;
            const sAmt = parseFloat(document.getElementById("srcAmt").value);
            const dAmt = parseFloat(document.getElementById("destAmt").value);
            const sCurr = document.getElementById("srcCurr").value;
            const dCurr = document.getElementById("destCurr").value;

            if(!sAmt || sAmt <= 0) return alert("Montant invalide");

            // Sortie de la source
            if(srcIdx === "caisse") {
                data.caisse[sCurr] -= sAmt;
            } else {
                data.operators[parseInt(srcIdx)][sCurr] -= sAmt;
            }

            // Entr√©e dans la destination
            if(destIdx === "caisse") {
                data.caisse[dCurr] += dAmt;
            } else {
                data.operators[parseInt(destIdx)][dCurr] += dAmt;
            }

            const srcName = srcIdx === "caisse" ? "Caisse" : data.operators[srcIdx].name;
            const destName = destIdx === "caisse" ? "Caisse" : data.operators[destIdx].name;

            data.transactions.unshift({
                date: new Date().toLocaleString(),
                desc: `TRANSFERT/CHANGE`,
                amt: sAmt,
                curr: sCurr,
                motif: `${srcName} (${sAmt}${sCurr}) ‚ûî ${destName} (${dAmt}${dCurr})`
            });

            saveData();
            alert("Transfert effectu√© !");
            document.getElementById("srcAmt").value = "";
            document.getElementById("destAmt").value = "";
        };

        window.addTransaction = () => {
            const opIdx = document.getElementById("operatorSelect").value;
            const tyIdx = document.getElementById("typeSelect").value;
            const amt = parseFloat(document.getElementById("amount").value) || 0;
            const curr = document.getElementById("currency").value;
            const payMode = document.getElementById("paymentSource").value;

            const ty = data.types[tyIdx];
            const op = data.operators[opIdx];

            op[curr] += (amt * ty.impO);
            op.stock += (amt * ty.impS);

            if(payMode === "cash") {
                data.caisse[curr] += (amt * ty.impC);
            } else {
                const payOpIdx = document.getElementById("paymentSimSelect").value;
                data.operators[payOpIdx][curr] += amt;
            }

            data.transactions.unshift({ date: new Date().toLocaleString(), desc: `${ty.name} | ${op.name}`, amt: amt, curr: curr, motif: document.getElementById("motif").value });
            saveData();
            alert("Enregistr√©");
        };

        window.addOperator = () => {
            const n = document.getElementById("newOpName").value;
            if(!n) return;
            data.operators.push({ name: n, USD: parseFloat(document.getElementById("initUSD").value)||0, CDF: parseFloat(document.getElementById("initCDF").value)||0, stock: parseFloat(document.getElementById("initStock").value)||0 });
            saveData();
        };

        window.addType = () => {
            const n = document.getElementById("newTypeName").value;
            if(!n) return;
            data.types.push({ name: n, impO: parseInt(document.getElementById("impO").value), impS: parseInt(document.getElementById("impS").value), impC: parseInt(document.getElementById("impC").value) });
            saveData();
        };

        window.deleteOp = (i) => { if(confirm("Supprimer?")) { data.operators.splice(i,1); saveData(); }};
        window.deleteType = (i) => { if(confirm("Supprimer?")) { data.types.splice(i,1); saveData(); }};
        window.togglePaymentSim = () => document.getElementById("paymentSimContainer").classList.toggle("hidden", document.getElementById("paymentSource").value === "cash");
        window.toggleFullHistory = () => { showFull = !showFull; render(); };

        function render() {
            if(document.getElementById("appSection").classList.contains("hidden")) return;
            document.getElementById("caisseUSD").innerText = data.caisse.USD.toLocaleString();
            document.getElementById("caisseCDF").innerText = data.caisse.CDF.toLocaleString();
            document.getElementById("displayTaux").innerText = data.taux.toLocaleString();

            let opH = "", opOpt = '<option value="caisse">Caisse Cash</option>', adminOpH = "";
            let opSelectOnly = ""; // Pour les transactions normales

            data.operators.forEach((o, i) => {
                opH += `<div class="card"><strong>${o.name}</strong><br>${o.USD}$ | ${o.CDF}FC | Stock: ${o.stock}</div>`;
                opOpt += `<option value="${i}">${o.name}</option>`;
                opSelectOnly += `<option value="${i}">${o.name}</option>`;
                adminOpH += `<div class="flex-row"><span>${o.name}</span><button class="btn-del" onclick="deleteOp(${i})">X</button></div>`;
            });
            
            document.getElementById("operatorBalances").innerHTML = opH;
            document.getElementById("srcWallet").innerHTML = opOpt;
            document.getElementById("destWallet").innerHTML = opOpt;
            document.getElementById("operatorSelect").innerHTML = opSelectOnly;
            document.getElementById("paymentSimSelect").innerHTML = opSelectOnly;
            document.getElementById("adminOpList").innerHTML = adminOpH;

            let tyOpt = ""; let adminTyH = "";
            data.types.forEach((t, i) => {
                tyOpt += `<option value="${i}">${t.name}</option>`;
                adminTyH += `<div class="flex-row"><span>${t.name}</span><button class="btn-del" onclick="deleteType(${i})">X</button></div>`;
            });
            document.getElementById("typeSelect").innerHTML = tyOpt;
            document.getElementById("adminTypeList").innerHTML = adminTyH;

            const list = showFull ? data.transactions : data.transactions.slice(0, 10);
            document.getElementById("history").innerHTML = list.map(t => `<div class="card" style="font-size:12px"><b>${t.date}</b><br>${t.desc}: ${t.amt} ${t.curr}<br><small>${t.motif || ""}</small></div>`).join("");
        }
    </script>
</body>
</html>

