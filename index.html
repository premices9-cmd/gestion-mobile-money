<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Gestion Mobile Money Pro</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {font-family: Arial; background:#0f172a; margin:0; color:white}
h1 {text-align:center; padding:15px}
.container {background:white; color:black; margin:15px; padding:15px; border-radius:15px}
input, select, button {padding:8px; margin:5px; border-radius:8px; border:1px solid #ccc}
button {cursor:pointer; background:#0f172a; color:white}
.card {background:#f1f5f9; padding:8px; margin:5px; border-radius:8px}
.hidden {display:none}
hr {margin:25px 0}
</style>
</head>

<body>

<h1>Gestion Mobile Money Pro</h1>

<div class="container">

<div id="loginSection">
<h2>Connexion</h2>
<input type="password" id="loginPin" placeholder="PIN">
<button onclick="login()">Se connecter</button>
</div>

<div id="appSection" class="hidden">

<button onclick="logout()">Déconnexion</button>

<h2>Solde Caisse</h2>
<p>USD: <span id="caisseUSD">0</span></p>
<p>CDF: <span id="caisseCDF">0</span></p>

<h2>Solde Opérateurs</h2>
<div id="operatorBalances"></div>

<hr>

<h2>Nouvelle Transaction</h2>
<select id="operatorSelect"></select>
<select id="typeSelect"></select>

<select id="currency">
<option value="USD">USD</option>
<option value="CDF">CDF</option>
</select>

<input type="number" id="amount" placeholder="Montant">
<input type="text" id="motif" placeholder="Motif">

<button onclick="addTransaction()">Valider</button>

<hr>

<h2>Historique</h2>
<div id="history"></div>

<button onclick="exportPDF()">Exporter PDF</button>

<hr>

<div id="adminSection">

<h3>Ajouter opérateur</h3>
<input type="text" id="newOperator" placeholder="Nom">
<select id="operatorCategory">
<option value="money">Money</option>
<option value="stock">Stock</option>
<option value="mixte">Mixte</option>
</select>
<input type="number" id="opInitUSD" placeholder="USD">
<input type="number" id="opInitCDF" placeholder="CDF">
<input type="number" id="stockPriceUSD" placeholder="Prix Stock USD">
<button onclick="addOperator()">Ajouter</button>

</div>

</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDSK9sIPu8fvGebZQG9EdHBhlf7nl8Dmzs",
  authDomain: "mka-mobile-money.firebaseapp.com",
  databaseURL: "https://mka-mobile-money-default-rtdb.firebaseio.com",
  projectId: "mka-mobile-money"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let caisse = {USD:0,CDF:0};
let operators = [];
let types = [];
let transactions = [];

let adminPin = "1234";
let employeePin = "0000";
let loggedIn = null;

async function saveOnline(){
await set(ref(db,"data"),{
caisse,operators,transactions
});
}

async function loadOnline(){
let snap = await get(ref(db,"data"));
if(snap.exists()){
let data = snap.val();
caisse = data.caisse || caisse;
operators = data.operators || [];
transactions = data.transactions || [];
}
display();
}

window.login = function(){
let pin=document.getElementById("loginPin").value;
if(pin===adminPin){
loggedIn="admin";
}else if(pin===employeePin){
loggedIn="employee";
}else{
alert("PIN incorrect");
return;
}

document.getElementById("loginSection").classList.add("hidden");
document.getElementById("appSection").classList.remove("hidden");

if(loggedIn==="employee"){
document.getElementById("adminSection").style.display="none";
}

loadOnline();
}

window.logout = function(){
location.reload();
}

window.addOperator = function(){
if(loggedIn!=="admin") return;

let name=document.getElementById("newOperator").value;
let category=document.getElementById("operatorCategory").value;
let usd=parseFloat(document.getElementById("opInitUSD").value)||0;
let cdf=parseFloat(document.getElementById("opInitCDF").value)||0;
let price=parseFloat(document.getElementById("stockPriceUSD").value)||0;

let op={name,category,USD:usd,CDF:cdf,stock:0,priceUSD:price};
operators.push(op);

saveOnline();
display();
}

window.addTransaction = function(){

let opIndex=document.getElementById("operatorSelect").value;
let currency=document.getElementById("currency").value;
let amount=parseFloat(document.getElementById("amount").value);
let motif=document.getElementById("motif").value;

if(amount<=0) return;

let op=operators[opIndex];

if(op.category==="stock"){
if(op.stock<amount){ alert("Stock insuffisant"); return; }
op.stock-=amount;
let total=amount*op.priceUSD;
op.USD+=total;
caisse.USD+=total;
}else{
op[currency]+=amount;
caisse[currency]+=amount;
}

transactions.push({
date:new Date(),
operator:op.name,
amount,
currency,
motif
});

saveOnline();
display();
}

function display(){
document.getElementById("caisseUSD").innerText=caisse.USD;
document.getElementById("caisseCDF").innerText=caisse.CDF;

let html="";
let select="";
operators.forEach((op,i)=>{
html+=`<div class="card">
${op.name} | Cat:${op.category} | Stock:${op.stock} | USD:${op.USD} | CDF:${op.CDF}
</div>`;
select+=`<option value="${i}">${op.name}</option>`;
});
document.getElementById("operatorBalances").innerHTML=html;
document.getElementById("operatorSelect").innerHTML=select;

let history="";
transactions.slice().reverse().forEach(t=>{
history+=`<div class="card">
${new Date(t.date).toLocaleString()} | ${t.operator} | ${t.amount} ${t.currency}
</div>`;
});
document.getElementById("history").innerHTML=history;
}

window.exportPDF = function(){
const { jsPDF } = window.jspdf;
let doc = new jsPDF();
let y=10;

doc.text("Rapport Mobile Money",10,y);
y+=10;

transactions.forEach(t=>{
doc.text(
`${new Date(t.date).toLocaleDateString()} - ${t.operator} - ${t.amount} ${t.currency}`,
10,y
);
y+=7;
});

doc.save("rapport.pdf");
}

</script>
</body>
</html>
