<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MKA V4 Expert Ultra - Fix</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; margin: 0; color: white; padding-bottom: 50px; }
        .container { background: white; color: black; margin: 10px; padding: 15px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        input, select, button { padding: 12px; margin: 5px 0; border-radius: 8px; border: 1px solid #cbd5e1; width: 100%; box-sizing: border-box; font-size: 14px; }
        button { cursor: pointer; background: #0f172a; color: white; font-weight: bold; border: none; transition: 0.2s; }
        button:active { transform: scale(0.96); opacity: 0.8; }
        .card { background: #f1f5f9; padding: 12px; margin: 8px 0; border-radius: 8px; border-left: 5px solid #0f172a; font-size: 13px; color: #1e293b; }
        .hidden { display: none !important; }
        .vnc-box { background: linear-gradient(135deg, #1e293b, #0f172a); color: white; padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 15px; border: 2px solid #facc15; }
        .vnc-val { font-size: 30px; font-weight: bold; color: #facc15; }
        .admin-box { border: 2px solid #ef4444; padding: 15px; border-radius: 12px; margin-top: 20px; background: #fff1f2; color: #991b1b; }
        .label-sm { font-size: 11px; font-weight: bold; color: #64748b; margin-top: 5px; display: block; text-transform: uppercase; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .service-split { background: #fff7ed; border: 1px dashed #f97316; padding: 10px; border-radius: 8px; margin: 10px 0; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .modal-content { background: white; color: black; padding: 20px; border-radius: 15px; width: 95%; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body>

    <h1 style="text-align:center; padding: 10px;">MKA V4 Expert Ultra</h1>

    <div class="container">
        <div id="loginSection">
            <h2 style="text-align:center">Acc√®s</h2>
            <input type="password" id="pinInput" placeholder="Code PIN">
            <button onclick="login()" style="width:100%; padding: 15px;">OUVRIR</button>
        </div>

        <div id="appSection" class="hidden">
            <div class="vnc-box">
                <span style="font-size: 11px; opacity: 0.8;">VALEUR NETTE COMPTABLE (VNC)</span><br>
                <div class="vnc-val" id="totalVNC">0.00 $</div>
                <div style="font-size: 10px; margin-top: 5px;">March√©: <span id="rateM">0</span> | Retrait: <span id="rateR">0</span></div>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <button onclick="logout()" style="background:#ef4444; width:auto; padding:8px 15px; font-size:12px;">QUITTER</button>
                <div style="text-align:right; font-size: 13px;">
                    <strong>Cash :</strong> <span id="caisseUSD" style="color:#16a34a">0</span>$ | <span id="caisseCDF" style="color:#16a34a">0</span>FC
                </div>
            </div>

            <h3>Soldes & Stocks SIMs</h3>
            <div id="operatorBalances"></div>

            <hr>
            <div style="background:#f0f9ff; padding:12px; border:1px solid #0ea5e9; border-radius:10px; margin:10px 0;">
                <h4 style="margin:0 0 10px 0; color:#0369a1;">üîÑ Change & Transfert</h4>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MKA V4 Expert Ultra - Fix</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; margin: 0; color: white; padding-bottom: 50px; }
        .container { background: white; color: black; margin: 10px; padding: 15px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        input, select, button { padding: 12px; margin: 5px 0; border-radius: 8px; border: 1px solid #cbd5e1; width: 100%; box-sizing: border-box; font-size: 14px; }
        button { cursor: pointer; background: #0f172a; color: white; font-weight: bold; border: none; transition: 0.2s; }
        button:active { transform: scale(0.96); opacity: 0.8; }
        .card { background: #f1f5f9; padding: 12px; margin: 8px 0; border-radius: 8px; border-left: 5px solid #0f172a; font-size: 13px; color: #1e293b; }
        .hidden { display: none !important; }
        .vnc-box { background: linear-gradient(135deg, #1e293b, #0f172a); color: white; padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 15px; border: 2px solid #facc15; }
        .vnc-val { font-size: 30px; font-weight: bold; color: #facc15; }
        .admin-box { border: 2px solid #ef4444; padding: 15px; border-radius: 12px; margin-top: 20px; background: #fff1f2; color: #991b1b; }
        .label-sm { font-size: 11px; font-weight: bold; color: #64748b; margin-top: 5px; display: block; text-transform: uppercase; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .service-split { background: #fff7ed; border: 1px dashed #f97316; padding: 10px; border-radius: 8px; margin: 10px 0; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .modal-content { background: white; color: black; padding: 20px; border-radius: 15px; width: 95%; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body>

    <h1 style="text-align:center; padding: 10px;">MKA V4 Expert Ultra</h1>

    <div class="container">
        <div id="loginSection">
            <h2 style="text-align:center">Acc√®s</h2>
            <input type="password" id="pinInput" placeholder="Code PIN">
            <button onclick="login()" style="width:100%; padding: 15px;">OUVRIR</button>
        </div>

        <div id="appSection" class="hidden">
            <div class="vnc-box">
                <span style="font-size: 11px; opacity: 0.8;">VALEUR NETTE COMPTABLE (VNC)</span><br>
                <div class="vnc-val" id="totalVNC">0.00 $</div>
                <div style="font-size: 10px; margin-top: 5px;">March√©: <span id="rateM">0</span> | Retrait: <span id="rateR">0</span></div>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <button onclick="logout()" style="background:#ef4444; width:auto; padding:8px 15px; font-size:12px;">QUITTER</button>
                <div style="text-align:right; font-size: 13px;">
                    <strong>Cash :</strong> <span id="caisseUSD" style="color:#16a34a">0</span>$ | <span id="caisseCDF" style="color:#16a34a">0</span>FC
                </div>
            </div>

            <h3>Soldes & Stocks SIMs</h3>
            <div id="operatorBalances"></div>

            <hr>
            <div style="background:#f0f9ff; padding:12px; border:1px solid #0ea5e9; border-radius:10px; margin:10px 0;">
                <h4 style="margin:0 0 10px 0; color:#0369a1;">üîÑ Change & Transfert</h4>
                <select id="srcWallet" onchange="calcDest()"></select>
                <div class="grid-2">
                    <input type="number" id="srcAmt" placeholder="Montant" oninput="calcDest()">
                    <select id="srcCurr" onchange="calcDest()"><option value="USD">USD</option><option value="CDF">CDF</option></select>
                </div>
                <label class="label-sm">Vers :</label>
                <select id="destWallet"></select>
                <div class="grid-2">
                    <input type="number" id="destAmt" readonly style="background:#e2e8f0;">
                    <select id="destCurr" onchange="calcDest()"><option value="CDF">CDF</option><option value="USD">USD</option></select>
                </div>
                <button onclick="executeGlobalChange()" style="background:#0ea5e9; width:100%; margin-top:5px;">TRANSF√âRER</button>
            </div>

            <hr>
            <h2>Nouvelle Op√©ration</h2>
            <div class="grid-2">
                <select id="operatorSelect"></select>
                <select id="typeSelect" onchange="toggleServiceFields()"></select>
            </div>
            <div class="grid-2">
                <input type="number" id="amount" placeholder="Montant">
                <select id="currency"><option value="USD">USD</option><option value="CDF">CDF</option></select>
            </div>

            <div id="serviceFields" class="service-split hidden">
                <label class="label-sm">Calcul Rendu (D√©p√¥t/Retrait) :</label>
                <div class="grid-2">
                    <input type="number" id="serveUSD" placeholder="En $">
                    <div style="display:flex; gap:2px;">
                        <input type="number" id="serveCDF" placeholder="En FC">
                        <button onclick="autoCalcCDF()" style="width:45px; background:#f97316; font-size:10px;">CALC</button>
                    </div>
                </div>
                <input type="number" id="coutCash" value="0" placeholder="Frais/Com Cash $">
            </div>

            <label class="label-sm">R√®glement :</label>
            <select id="payMode" onchange="togglePaySim()">
                <option value="cash">Paiement Cash (Tiroir)</option>
                <option value="virtuel">Via une autre SIM</option>
                <option value="depense">D√©pense (Shop/Loyer/etc)</option>
                <option value="dette_client">Dette Client (Dehors)</option>
                <option value="dette_moi">Dette Moi (Cr√©dit)</option>
            </select>
            <div id="paySimBox" class="hidden"><select id="paySimSelect"></select></div>
            <input type="text" id="motif" placeholder="Commentaire / Client">
            <button onclick="addTransaction()" style="background:#16a34a; width:100%; margin-top:10px;">VALIDER L'OP√âRATION</button>

            <button onclick="showFullHistory()" style="background:#64748b; width:100%; margin-top:10px;">HISTORIQUE</button>

            <div id="adminSection" class="hidden">
                <div class="admin-box">
                    <h3>üîß Configuration Admin</h3>
                    
                    <div style="background:white; padding:10px; border-radius:8px; margin:10px 0; color:black;">
                        <h4>Gestion des Taux</h4>
                        <input type="number" id="newTaux" placeholder="March√©">
                        <input type="number" id="newTauxR" placeholder="Retrait">
                        <input type="number" id="newTauxA" placeholder="Achat CDF">
                        <button onclick="updateTaux()" style="width:100%">Mettre √† jour les taux</button>
                    </div>

                    <div style="background:white; padding:10px; border-radius:8px; margin:10px 0; color:black;">
                        <h4>Nouvel Op√©rateur (Stock & Soldes)</h4>
                        <input type="text" id="newOpName" placeholder="Nom">
                        <div class="grid-2">
                            <input type="number" id="startUSD" placeholder="Solde $">
                            <input type="number" id="startCDF" placeholder="Solde FC">
                        </div>
                        <div class="grid-2">
                            <input type="number" id="startStock" placeholder="Stock">
                            <input type="number" id="startPrice" placeholder="Prix Achat unitaire $">
                        </div>
                        <button onclick="addOperator()" style="width:100%; background:#b91c1c">Cr√©er</button>
                    </div>

                    <div style="background:white; padding:10px; border-radius:8px; margin:10px 0; color:black;">
                        <h4>Type d'Op√©ration (Impacts)</h4>
                        <input type="text" id="newTypeName" placeholder="Nom (Ex: Flash)">
                        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px;">
                            <select id="impO"><option value="0">S0</option><option value="1">S+</option><option value="-1">S-</option></select>
                            <select id="impC"><option value="0">C0</option><option value="1">C+</option><option value="-1">C-</option></select>
                            <select id="impK"><option value="0">K0</option><option value="1">K+</option><option value="-1">K-</option></select>
                        </div>
                        <button onclick="addType()" style="width:100%; background:#b91c1c; margin-top:5px">Enregistrer Type</button>
                        <div id="adminTypeList"></div>
                    </div>

                    <button onclick="editCaisse()" style="background:#334155; width:100%; margin-top:10px;">Modifier Cash Tiroir</button>
                    <div id="adminOpList"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="historyModal" class="modal hidden">
        <div class="modal-content">
            <button onclick="closeHistory()" style="background:#ef4444; float:right;">X</button>
            <h2>Historique</h2>
            <div id="fullHistoryList"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyDSK9sIPu8fvGebZQG9EdHBhlf7nl8Dmzs", authDomain: "mka-mobile-money.firebaseapp.com", databaseURL: "https://mka-mobile-money-default-rtdb.firebaseio.com", projectId: "mka-mobile-money" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let data = { caisse:{USD:0, CDF:0}, operators:[], types:[], transactions:[], taux:2800, tauxRetrait:2850, tauxAchat:2750 };

        onValue(ref(db, 'mka_data'), (snap) => {
            if(snap.val()) {
                data = snap.val();
                if(!data.operators) data.operators = [];
                render();
            }
        });

        const save = () => set(ref(db, 'mka_data'), data);

        window.login = () => {
            const p = document.getElementById("pinInput").value;
            if(p === "1234" || p === "0000") {
                document.getElementById("loginSection").classList.add("hidden");
                document.getElementById("appSection").classList.remove("hidden");
                if(p === "1234") document.getElementById("adminSection").classList.remove("hidden");
                render();
            } else { alert("Code PIN incorrect"); }
        };

        window.logout = () => location.reload();

        window.calcDest = () => {
            const amt = parseFloat(document.getElementById("srcAmt").value) || 0;
            const taux = data.taux || 2800;
            const sc = document.getElementById("srcCurr").value, dc = document.getElementById("destCurr").value;
            let res = (sc==="USD" && dc==="CDF") ? amt*taux : (sc==="CDF" && dc==="USD") ? amt/taux : amt;
            document.getElementById("destAmt").value = res.toFixed(2);
        };

        window.executeGlobalChange = () => {
            const sIdx = document.getElementById("srcWallet").value, dIdx = document.getElementById("destWallet").value;
            const sAmt = parseFloat(document.getElementById("srcAmt").value) || 0, dAmt = parseFloat(document.getElementById("destAmt").value) || 0;
            const sc = document.getElementById("srcCurr").value, dc = document.getElementById("destCurr").value;
            if(sAmt <= 0) return;
            if(sIdx === "caisse") data.caisse[sc] -= sAmt; else data.operators[sIdx][sc] -= sAmt;
            if(dIdx === "caisse") data.caisse[dc] += dAmt; else data.operators[dIdx][dc] += dAmt;
            data.transactions.unshift({ date: new Date().toLocaleString(), desc: "CHANGE/TRANSFERT", amt: sAmt, cur: sc });
            save();
        };

        window.autoCalcCDF = () => {
            const total = parseFloat(document.getElementById("amount").value) || 0;
            const usd = parseFloat(document.getElementById("serveUSD").value) || 0;
            const tR = data.tauxRetrait || 2850;
            const reste = total - usd;
            if(reste > 0) document.getElementById("serveCDF").value = Math.round(reste * tR);
        };

        window.addTransaction = () => {
            const opI = document.getElementById("operatorSelect").value, tyI = document.getElementById("typeSelect").value;
            const amt = parseFloat(document.getElementById("amount").value) || 0, cur = document.getElementById("currency").value;
            const mode = document.getElementById("payMode").value, motif = document.getElementById("motif").value;
            const ty = data.types[tyI], op = data.operators[opI];
            if(!ty || !op) return;

            op[cur] += (amt * ty.impO);
            if(ty.impK) op.stock = (parseFloat(op.stock)||0) + parseInt(ty.impK);

            const isSrv = ty.name.toLowerCase().includes("retrait") || ty.name.toLowerCase().includes("d√©p√¥t");

            if(isSrv && mode === "cash") {
                data.caisse.USD -= (parseFloat(document.getElementById("serveUSD").value) || 0);
                data.caisse.CDF -= (parseFloat(document.getElementById("serveCDF").value) || 0);
                data.caisse.USD += (parseFloat(document.getElementById("coutCash").value) || 0);
            } else if (mode === "depense") {
                let dep = data.operators.find(o => o.name === "D√©penses"); if(dep) dep[cur] += amt;
            } else if (mode === "cash") {
                data.caisse[cur] += (amt * ty.impC);
            } else if (mode === "virtuel") {
                data.operators[document.getElementById("paySimSelect").value][cur] += (amt * ty.impC);
            } else if (mode === "dette_client") {
                let detC = data.operators.find(o => o.name === "Dettes Client"); if(detC) detC[cur] += amt;
            } else if (mode === "dette_moi") {
                let detM = data.operators.find(o => o.name === "Dettes Moi"); if(detM) detM[cur] += amt;
            }
            data.transactions.unshift({ date: new Date().toLocaleString(), desc: `${ty.name}: ${motif}`, amt, cur });
            save(); alert("Enregistr√© avec succ√®s");
        };

        window.addOperator = () => {
            const n = document.getElementById("newOpName").value;
            if(n) {
                data.operators.push({
                    name: n,
                    USD: parseFloat(document.getElementById("startUSD").value) || 0,
                    CDF: parseFloat(document.getElementById("startCDF").value) || 0,
                    stock: parseFloat(document.getElementById("startStock").value) || 0,
                    unitPrice: parseFloat(document.getElementById("startPrice").value) || 0
                });
                save(); alert("Op√©rateur cr√©√©");
            }
        };

        window.addType = () => {
            const n = document.getElementById("newTypeName").value;
            if(n) {
                data.types.push({
                    name: n,
                    impO: parseInt(document.getElementById("impO").value),
                    impC: parseInt(document.getElementById("impC").value),
                    impK: parseInt(document.getElementById("impK").value)
                });
                save(); alert("Type ajout√©");
            }
        };

        window.updateTaux = () => {
            data.taux = parseFloat(document.getElementById("newTaux").value) || data.taux;
            data.tauxRetrait = parseFloat(document.getElementById("newTauxR").value) || data.tauxRetrait;
            data.tauxAchat = parseFloat(document.getElementById("newTauxA").value) || data.tauxAchat;
            save(); alert("Taux mis √† jour");
        };

        window.editCaisse = () => {
            data.caisse.USD = parseFloat(prompt("Modifier Cash USD :", data.caisse.USD)) || 0;
            data.caisse.CDF = parseFloat(prompt("Modifier Cash CDF :", data.caisse.CDF)) || 0;
            save();
        };

        window.delOp = (i) => { if(confirm("Supprimer?")) { data.operators.splice(i,1); save(); } };
        window.delType = (i) => { if(confirm("Supprimer?")) { data.types.splice(i,1); save(); } };

        window.toggleServiceFields = () => {
            const ty = data.types[document.getElementById("typeSelect").value];
            const show = ty && (ty.name.toLowerCase().includes("retrait") || ty.name.toLowerCase().includes("d√©p√¥t"));
            document.getElementById("serviceFields").classList.toggle("hidden", !show);
        };
        window.togglePaySim = () => document.getElementById("paySimBox").classList.toggle("hidden", document.getElementById("payMode").value !== "virtuel");
        window.showFullHistory = () => { document.getElementById("fullHistoryList").innerHTML = data.transactions.map(t => `<div class="card"><b>${t.date}</b>: ${t.desc} (${t.amt}${t.cur})</div>`).join(""); document.getElementById("historyModal").classList.remove("hidden"); };
        window.closeHistory = () => document.getElementById("historyModal").classList.add("hidden");

        function render() {
            if(document.getElementById("appSection").classList.contains("hidden")) return;
            const tM = data.taux || 2800;
            document.getElementById("caisseUSD").innerText = data.caisse.USD.toLocaleString();
            document.getElementById("caisseCDF").innerText = data.caisse.CDF.toLocaleString();
            document.getElementById("rateM").innerText = tM; 
            document.getElementById("rateR").innerText = data.tauxRetrait || 0;

            let vnc = (data.caisse.USD || 0) + ((data.caisse.CDF || 0) / tM);
            let opCards = "", opOnly = "", opWCash = '<option value="caisse">Tiroir Cash</option>';

            data.operators.forEach((o, i) => {
                const u = parseFloat(o.USD)||0, c = parseFloat(o.CDF)||0, k = parseFloat(o.stock)||0, p = parseFloat(o.unitPrice)||0;
                let val = u + (c / tM) + (k * p);
                
                if(o.name === "Dettes Client") vnc += val;
                else if(o.name === "Dettes Moi" || o.name === "D√©penses") vnc -= val;
                else vnc += val;
                
                opCards += `<div class="card"><b>${o.name}</b>: ${u}$ | ${c}FC<br><small>Stock: ${k} (P.A: ${p}$)</small></div>`;
                opOnly += `<option value="${i}">${o.name}</option>`;
                opWCash += `<option value="${i}">${o.name}</option>`;
            });

            document.getElementById("totalVNC").innerText = vnc.toFixed(2) + " $";
            document.getElementById("operatorBalances").innerHTML = opCards;
            document.getElementById("srcWallet").innerHTML = opWCash;
            document.getElementById("destWallet").innerHTML = opWCash;
            document.getElementById("operatorSelect").innerHTML = opOnly;
            document.getElementById("paySimSelect").innerHTML = opOnly;
            document.getElementById("typeSelect").innerHTML = data.types.map((t,i) => `<option value="${i}">${t.name}</option>`).join("");
            document.getElementById("adminTypeList").innerHTML = data.types.map((t,i) => `<div class="card" style="margin:2px; font-size:10px;">${t.name} <button onclick="delType(${i})" style="background:red; padding:2px; float:right;">X</button></div>`).join("");
            document.getElementById("adminOpList").innerHTML = data.operators.map((o,i) => `<div class="card" style="margin:2px; font-size:10px;">${o.name} <button onclick="delOp(${i})" style="background:red; padding:2px; float:right;">X</button></div>`).join("");
        }
    </script>
</body>
</html>
ÔøºEnter                <select id="srcWallet" onchange="calcDest()"></select>
                <div class="grid-2">
                    <input type="number" id="srcAmt" placeholder="Montant" oninput="calcDest()">
                    <select id="srcCurr" onchange="calcDest()"><option value="USD">USD</option><option value="CDF">CDF</option></select>
                </div>
                <label class="label-sm">Vers :</label>
                <select id="destWallet"></select>
                <div class="grid-2">
                    <input type="number" id="destAmt" readonly style="background:#e2e8f0;">
                    <select id="destCurr" onchange="calcDest()"><option value="CDF">CDF</option><option value="USD">USD</option></select>
                </div>
                <button onclick="executeGlobalChange()" style="background:#0ea5e9; width:100%; margin-top:5px;">TRANSF√âRER</button>
            </div>

            <hr>
            <h2>Nouvelle Op√©ration</h2>
            <div class="grid-2">
                <select id="operatorSelect"></select>
                <select id="typeSelect" onchange="toggleServiceFields()"></select>
            </div>
            <div class="grid-2">
                <input type="number" id="amount" placeholder="Montant">
                <select id="currency"><option value="USD">USD</option><option value="CDF">CDF</option></select>
            </div>

            <div id="serviceFields" class="service-split hidden">
                <label class="label-sm">Calcul Rendu (D√©p√¥t/Retrait) :</label>
                <div class="grid-2">
                    <input type="number" id="serveUSD" placeholder="En $">
                    <div style="display:flex; gap:2px;">
                        <input type="number" id="serveCDF" placeholder="En FC">
                        <button onclick="autoCalcCDF()" style="width:45px; background:#f97316; font-size:10px;">CALC</button>
                    </div>
                </div>
                <input type="number" id="coutCash" value="0" placeholder="Frais/Com Cash $">
            </div>

            <label class="label-sm">R√®glement :</label>
            <select id="payMode" onchange="togglePaySim()">
                <option value="cash">Paiement Cash (Tiroir)</option>
                <option value="virtuel">Via une autre SIM</option>
                <option value="depense">D√©pense (Shop/Loyer/etc)</option>
                <option value="dette_client">Dette Client (Dehors)</option>
                <option value="dette_moi">Dette Moi (Cr√©dit)</option>
            </select>
            <div id="paySimBox" class="hidden"><select id="paySimSelect"></select></div>
            <input type="text" id="motif" placeholder="Commentaire / Client">
            <button onclick="addTransaction()" style="background:#16a34a; width:100%; margin-top:10px;">VALIDER L'OP√âRATION</button>

            <button onclick="showFullHistory()" style="background:#64748b; width:100%; margin-top:10px;">HISTORIQUE</button>

            <div id="adminSection" class="hidden">
                <div class="admin-box">
                    <h3>üîß Configuration Admin</h3>
                    
                    <div style="background:white; padding:10px; border-radius:8px; margin:10px 0; color:black;">
                        <h4>Gestion des Taux</h4>
                        <input type="number" id="newTaux" placeholder="March√©">
                        <input type="number" id="newTauxR" placeholder="Retrait">
                        <input type="number" id="newTauxA" placeholder="Achat CDF">
                        <button onclick="updateTaux()" style="width:100%">Mettre √† jour les taux</button>
                    </div>

                    <div style="background:white; padding:10px; border-radius:8px; margin:10px 0; color:black;">
                        <h4>Nouvel Op√©rateur (Stock & Soldes)</h4>
                        <input type="text" id="newOpName" placeholder="Nom">
                        <div class="grid-2">
                            <input type="number" id="startUSD" placeholder="Solde $">
                            <input type="number" id="startCDF" placeholder="Solde FC">
                        </div>
                        <div class="grid-2">
                            <input type="number" id="startStock" placeholder="Stock">
                            <input type="number" id="startPrice" placeholder="Prix Achat unitaire $">
                        </div>
                        <button onclick="addOperator()" style="width:100%; background:#b91c1c">Cr√©er</button>
                    </div>

                    <div style="background:white; padding:10px; border-radius:8px; margin:10px 0; color:black;">
                        <h4>Type d'Op√©ration (Impacts)</h4>
                        <input type="text" id="newTypeName" placeholder="Nom (Ex: Flash)">
                        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px;">
                            <select id="impO"><option value="0">S0</option><option value="1">S+</option><option value="-1">S-</option></select>
                            <select id="impC"><option value="0">C0</option><option value="1">C+</option><option value="-1">C-</option></select>
                            <select id="impK"><option value="0">K0</option><option value="1">K+</option><option value="-1">K-</option></select>
                        </div>
                        <button onclick="addType()" style="width:100%; background:#b91c1c; margin-top:5px">Enregistrer Type</button>
                        <div id="adminTypeList"></div>
                    </div>

                    <button onclick="editCaisse()" style="background:#334155; width:100%; margin-top:10px;">Modifier Cash Tiroir</button>
                    <div id="adminOpList"></div>
                </div>
            </div>
        </div>
div>

    <div id="historyModal" class="modal hidden">
        <div class="modal-content">
            <button onclick="closeHistory()" style="background:#ef4444; float:right;">X</button>
            <h2>Historique</h2>
            <div id="fullHistoryList"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyDSK9sIPu8fvGebZQG9EdHBhlf7nl8Dmzs", authDomain: "mka-mobile-money.firebaseapp.com", databaseURL: "https://mka-mobile-money-default-rtdb.firebaseio.com", projectId: "mka-mobile-money" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let data = { caisse:{USD:0, CDF:0}, operators:[], types:[], transactions:[], taux:2800, tauxRetrait:2850, tauxAchat:2750 };

        onValue(ref(db, 'mka_data'), (snap) => {
            if(snap.val()) {
                data = snap.val();
                if(!data.operators) data.operators = [];
                render();
            }
        });

        const save = () => set(ref(db, 'mka_data'), data);

        window.login = () => {
            const p = document.getElementById("pinInput").value;
            if(p === "1234" || p === "0000") {
                document.getElementById("loginSection").classList.add("hidden");
                document.getElementById("appSection").classList.remove("hidden");
                if(p === "1234") document.getElementById("adminSection").classList.remove("hidden");
                render();
            } else { alert("Code PIN incorrect"); }
        };

        window.logout = () => location.reload();

        window.calcDest = () => {
            const amt = parseFloat(document.getElementById("srcAmt").value) || 0;
            const taux = data.taux || 2800;
            const sc = document.getElementById("srcCurr").value, dc = document.getElementById("destCurr").value;
            let res = (sc==="USD" && dc==="CDF") ? amt*taux : (sc==="CDF" && dc==="USD") ? amt/taux : amt;
            document.getElementById("destAmt").value = res.toFixed(2);
        };

        window.executeGlobalChange = () => {
            const sIdx = document.getElementById("srcWallet").value, dIdx = document.getElementById("destWallet").value;
            const sAmt = parseFloat(document.getElementById("srcAmt").value) || 0, dAmt = parseFloat(document.getElementById("destAmt").value) || 0;
            const sc = document.getElementById("srcCurr").value, dc = document.getElementById("destCurr").value;
            if(sAmt <= 0) return;
            if(sIdx === "caisse") data.caisse[sc] -= sAmt; else data.operators[sIdx][sc] -= sAmt;
            if(dIdx === "caisse") data.caisse[dc] += dAmt; else data.operators[dIdx][dc] += dAmt;
            data.transactions.unshift({ date: new Date().toLocaleString(), desc: "CHANGE/TRANSFERT", amt: sAmt, cur: sc });
            save();
        };

        window.autoCalcCDF = () => {
            const total = parseFloat(document.getElementById("amount").value) || 0;
            const usd = parseFloat(document.getElementById("serveUSD").value) || 0;
            const tR = data.tauxRetrait || 2850;
            const reste = total - usd;
            if(reste > 0) document.getElementById("serveCDF").value = Math.round(reste * tR);
        };

        window.addTransaction = () => {
            const opI = document.getElementById("operatorSelect").value, tyI = document.getElementById("typeSelect").value;
            const amt = parseFloat(document.getElementById("amount").value) || 0, cur = document.getElementById("currency").value;
            const mode = document.getElementById("payMode").value, motif = document.getElementById("motif").value;
            const ty = data.types[tyI], op = data.operators[opI];
            if(!ty || !op) return;

            op[cur] += (amt * ty.impO);
            if(ty.impK) op.stock = (parseFloat(op.stock)||0) + parseInt(ty.impK);

            const isSrv = ty.name.toLowerCase().includes("retrait") || ty.name.toLowerCase().includes("d√©p√¥t");

            if(isSrv && mode === "cash") {
                data.caisse.USD -= (parseFloat(document.getElementById("serveUSD").value) || 0);
                data.caisse.CDF -= (parseFloat(document.getElementById("serveCDF").value) || 0);
                data.caisse.USD += (parseFloat(document.getElementById("coutCash").value) || 0);
            } else if (mode === "depense") {
                let dep = data.operators.find(o => o.name === "D√©penses"); if(dep) dep[cur] += amt;
            } else if (mode === "cash") {
                data.caisse[cur] += (amt * ty.impC);
            } else if (mode === "virtuel") {
                data.operators[document.getElementById("paySimSelect").value][cur] += (amt * ty.impC);
            } else if (mode === "dette_client") {
                let detC = data.operators.find(o => o.name === "Dettes Client"); if(detC) detC[cur] += amt;
            } else if (mode === "dette_moi") {
                let detM = data.operators.find(o => o.name === "Dettes Moi"); if(detM) detM[cur] += amt;
