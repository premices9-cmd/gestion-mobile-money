<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MKA PRO V16.1 - VERSION FINALE</title>
    <style>
        :root { --p: #0f172a; --s: #16a34a; --d: #ef4444; --w: #facc15; --a: #8b5cf6; --i: #3b82f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--p); margin: 0; color: white; padding-bottom: 30px; }
        .container { background: white; color: black; margin: 10px; padding: 15px; border-radius: 15px; min-height: 95vh; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        input, select, button { padding: 12px; margin: 5px 0; border-radius: 8px; border: 1px solid #cbd5e1; width: 100%; box-sizing: border-box; font-size: 14px; }
        button { cursor: pointer; background: var(--p); color: white; font-weight: bold; border: none; transition: 0.2s; }
        button:active { transform: scale(0.98); }
        .vnc-box { background: linear-gradient(135deg, #1e293b, #0f172a); color: white; padding: 15px; border-radius: 12px; text-align: center; border: 2px solid var(--w); margin-bottom: 10px; }
        .vnc-val { font-size: 28px; font-weight: bold; color: var(--w); }
        .card { background: #f8fafc; padding: 10px; margin: 5px 0; border-radius: 8px; border-left: 5px solid var(--p); font-size: 13px; display: flex; justify-content: space-between; border: 1px solid #e2e8f0; align-items: center; }
        .hidden { display: none !important; }
        .section-title { font-size: 10px; font-weight: bold; color: #64748b; text-transform: uppercase; margin-top: 15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 3px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .action-card { background: #f1f5f9; padding: 12px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #cbd5e1; }
        .pos { color: var(--s); font-weight: bold; }
        .neg { color: var(--d); font-weight: bold; }
        .hist-item { font-size: 10px; border-bottom: 1px solid #eee; padding: 5px 0; color: #334155; }
    </style>
</head>
<body>

<div class="container">
    <div id="loginPage" style="padding:50px 0; text-align:center;">
        <h2 style="color:var(--p); margin-bottom:30px;">MKA PRO V16.1<br><small style="font-size:12px; color:#64748b;">Syst√®me de Gestion Int√©gral</small></h2>
        <input type="password" id="pin" placeholder="ENTREZ VOTRE PIN" style="text-align:center; font-size:20px; letter-spacing:5px;">
        <button onclick="login()" style="background:var(--s); margin-top:20px;">OUVRIR LA SESSION</button>
    </div>

    <div id="mainApp" class="hidden">
        <div class="vnc-box">
            <small>VALEUR NETTE COMPTABLE (VNC)</small><br>
            <div class="vnc-val" id="vncDisp">0.00 $</div>
            <div style="font-size:11px;">Taux March√©: <span id="tauxDisp">0</span> | Taux Retrait: <span id="tauxRetDisp">0</span></div>
        </div>

        <div style="display:flex; justify-content:space-between; margin-bottom:10px; gap:5px;">
            <button onclick="location.reload()" style="background:var(--d); flex:1;">Quitter</button>
            <button onclick="toggleHist()" style="background:var(--i); flex:1;">üìú Journal</button>
            <div style="text-align:right; flex:1.5;">
                <span id="cashUSD" class="pos" style="font-size:16px;">0</span> $ <br>
                <span id="cashCDF" class="pos" style="font-size:14px;">0</span> FC
            </div>
        </div>

        <div id="accountList"></div>

        <div id="histBox" class="hidden action-card" style="max-height: 200px; overflow-y: auto; background:white;">
            <div class="section-title">Derniers mouvements</div>
            <div id="histContent"></div>
        </div>

        <div class="section-title">üí± BUREAU DE CHANGE (CASH)</div>
        <div class="action-card">
            <div class="grid">
                <select id="chDir"><option value="buy">J'ach√®te $ (Donne FC)</option><option value="sell">Je vends $ (Re√ßois FC)</option></select>
                <input type="number" id="chAmt" placeholder="Montant USD" oninput="calcCh()">
            </div>
            <div class="grid">
                <input type="number" id="chRate" placeholder="Taux appliqu√©">
                <input type="number" id="chRes" placeholder="R√©sultat FC" readonly style="background:#e2e8f0; font-weight:bold;">
            </div>
            <button onclick="execChange()" style="background:var(--w); color:black; margin-top:5px;">VALIDER LE CHANGE</button>
        </div>

        <div class="section-title">üèß RETRAIT MIXTE (CLIENT)</div>
        <div class="action-card">
            <select id="retSim"></select>
            <div class="grid">
                <input type="number" id="retTot" placeholder="Total SIM ($)" oninput="calcRM()">
                <input type="number" id="retFr" placeholder="Frais Cash ($)" oninput="calcRM()">
            </div>
            <div class="grid">
                <input type="number" id="gU" placeholder="Donner USD Cash" oninput="calcRM()">
                <input type="number" id="gC" placeholder="Reste en CDF" readonly style="background:#e2e8f0; font-weight:bold;">
            </div>
            <button onclick="execRM()" style="background:var(--s); margin-top:5px;">VALIDER LE RETRAIT</button>
        </div>

        <div class="section-title">üîÑ MOUVEMENTS (VENTE STOCK, DETTE, DEPENSE)</div>
        <div class="action-card">
            <select id="opTypeSelect"></select>
            <div class="grid"><select id="src" title="Source"></select><select id="dst" title="Destination"></select></div>
            <div class="grid">
                <input type="number" id="amt" placeholder="Montant">
                <select id="cur"><option value="USD">USD</option><option value="CDF">CDF</option></select>
            </div>
            <button onclick="execMove()" style="background:var(--i); margin-top:5px;">VALIDER L'OP√âRATION</button>
        </div>

        <div id="adminPanel" class="hidden" style="background:#f5f3ff; padding:15px; border-radius:12px; margin-top:25px; border:2px solid var(--a);">
            <h3 style="margin:0; color:var(--a); font-size:14px;">üîê ADMINISTRATION & CONFIG</h3>
            
            <div class="section-title">Ajuster Soldes (Correction)</div>
            <select id="adjT"></select>
            <div class="grid"><input type="number" id="adjU" placeholder="Nouv. USD"><input type="number" id="adjC" placeholder="Nouv. CDF"></div>
            <button onclick="execAdj()" style="background:var(--d)">√âCRASER ET METTRE √Ä JOUR</button>

            <div class="section-title">Cr√©er Compte / SIM</div>
            <div class="grid"><input type="text" id="nn" placeholder="Nom"><button onclick="addAcc()" style="background:var(--a)">+ CR√âER</button></div>

            <div class="section-title">R√©glage des Taux</div>
            <div class="grid"><input type="number" id="setT" placeholder="Taux March√©"><input type="number" id="setTR" placeholder="Taux Retrait"></div>
            <button onclick="upT()" style="background:var(--p)">MAJ TAUX</button>
            
            <div class="section-title">Gestion de la liste</div>
            <div id="delList"></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

    const conf = { apiKey: "AIzaSyDSK9sIPu8fvGebZQG9EdHBhlf7nl8Dmzs", databaseURL: "https://mka-mobile-money-default-rtdb.firebaseio.com", projectId: "mka-mobile-money" };
    const app = initializeApp(conf);
    const db = getDatabase(app);
    
    let data = { caisse: {USD:0, CDF:0}, accounts: [], history: [], types: ["Vente Stock", "Paiement Dette", "D√©pense Cash", "D√©pense Virtuelle", "R√©appro Stock"], taux: 2850, tauxRet: 2800 };

    onValue(ref(db, 'mka_data'), (s) => { if(s.val()){ data = s.val(); render(); }});

    const pushData = (m) => { 
        data.history.unshift({d: new Date().toLocaleString('fr-FR'), m});
        if(data.history.length > 50) data.history.pop();
        set(ref(db, 'mka_data'), data);
    };

    window.login = () => {
        const p = document.getElementById("pin").value;
        if(p === "admin1011") { document.getElementById("loginPage").classList.add("hidden"); document.getElementById("mainApp").classList.remove("hidden"); document.getElementById("adminPanel").classList.remove("hidden"); }
        else if(p === "1320") { document.getElementById("loginPage").classList.add("hidden"); document.getElementById("mainApp").classList.remove("hidden"); }
        else alert("PIN Erron√©");
    };

    // LOGIQUE CHANGE
    window.calcCh = () => { const a = document.getElementById("chAmt").value; const r = document.getElementById("chRate").value || data.taux; document.getElementById("chRes").value = Math.round(a * r); };
    window.execChange = () => {
        const d = document.getElementById("chDir").value; const u = parseFloat(document.getElementById("chAmt").value); const c = parseFloat(document.getElementById("chRes").value);
        if(u > 0) {
            if(d === "buy") { data.caisse.USD += u; data.caisse.CDF -= c; } else { data.caisse.USD -= u; data.caisse.CDF += c; }
            pushData(`CHANGE: ${d==="buy"?"Achat":"Vente"} de ${u}$ au taux ${document.getElementById("chRate").value}`);
            alert("Change effectu√©");
        }
    };

    // LOGIQUE RETRAIT MIXTE
    window.calcRM = () => {
        const t = document.getElementById("retTot").value; const f = document.getElementById("retFr").value; const g = document.getElementById("gU").value;
        const res = (t - f - g) * data.tauxRet; document.getElementById("gC").value = res > 0 ? Math.round(res) : 0;
    };
    window.execRM = () => {
        const i = document.getElementById("retSim").value; const t = parseFloat(document.getElementById("retTot").value); const u = parseFloat(document.getElementById("gU").value); const c = parseFloat(document.getElementById("gC").value);
        if(t > 0) {
            data.accounts[i].USD += t; data.caisse.USD -= u; data.caisse.CDF -= c;
            pushData(`RETRAIT: ${data.accounts[i].name} (+${t}$ virt.), Cash sorti: ${u}$ et ${c}FC`);
            alert("Retrait valid√©");
        }
    };

    // LOGIQUE MOUVEMENTS UNIVERSELS
    window.execMove = () => {
        const tp = document.getElementById("opTypeSelect").value; const s = document.getElementById("src").value; const d = document.getElementById("dst").value;
        const a = parseFloat(document.getElementById("amt").value); const c = document.getElementById("cur").value;
        if(a > 0 && s !== d) {
            if(s === "c") data.caisse[c] -= a; else data.accounts[s][c] -= a;
            if(d === "c") data.caisse[c] += a; else data.accounts[d][c] += a;
            pushData(`${tp}: ${s==="c"?"Caisse":data.accounts[s].name} vers ${d==="c"?"Caisse":data.accounts[d].name} (${a}${c})`);
            alert("Op√©ration r√©ussie");
        }
    };

    // LOGIQUE ADMIN
    window.execAdj = () => {
        const t = document.getElementById("adjT").value; const u = parseFloat(document.getElementById("adjU").value); const c = parseFloat(document.getElementById("adjC").value);
        if(t === "c") { data.caisse.USD = u; data.caisse.CDF = c; } else { data.accounts[t].USD = u; data.accounts[t].CDF = c; }
        pushData(`AJUSTEMENT ADMIN sur ${t==="c"?"Caisse":data.accounts[t].name}`); alert("Soldes forc√©s avec succ√®s");
    };
    window.addAcc = () => { const n = document.getElementById("nn").value; if(n){ data.accounts.push({name:n, USD:0, CDF:0}); pushData(`COMPTE CR√â√â: ${n}`); document.getElementById("nn").value=""; }};
    window.upT = () => { data.taux = parseFloat(document.getElementById("setT").value) || data.taux; data.tauxRet = parseFloat(document.getElementById("setTR").value) || data.tauxRet; pushData(`TAUX MIS √Ä JOUR`); alert("Taux enregistr√©s"); };
    window.delAcc = (i) => { if(confirm("Supprimer ?")){ data.accounts.splice(i,1); pushData("COMPTE SUPPRIM√â"); set(ref(db, 'mka_data'), data); }};
    window.toggleHist = () => document.getElementById("histBox").classList.toggle("hidden");

    function render() {
        document.getElementById("tauxDisp").innerText = data.taux;
        document.getElementById("tauxRetDisp").innerText = data.tauxRet;
        document.getElementById("cashUSD").innerText = data.caisse.USD.toFixed(2);
        document.getElementById("cashCDF").innerText = data.caisse.CDF.toLocaleString();
        if(!document.getElementById("chRate").value) document.getElementById("chRate").value = data.taux;

        let vnc = data.caisse.USD + (data.caisse.CDF / data.taux);
        document.getElementById("accountList").innerHTML = data.accounts.map((a, i) => {
            vnc += a.USD + (a.CDF / data.taux);
            return `<div class="card"><b>${a.name}</b><span class="${a.USD<0?'neg':'pos'}">${a.USD.toFixed(1)}$ | ${a.CDF}F</span></div>`;
        }).join("");
        document.getElementById("vncDisp").innerText = vnc.toFixed(2) + " $";

        const opts = `<option value="c">üí∞ CAISSE CASH</option>` + data.accounts.map((a,i)=>`<option value="${i}">${a.name}</option>`).join("");
        document.getElementById("src").innerHTML = opts; document.getElementById("dst").innerHTML = opts;
        document.getElementById("retSim").innerHTML = data.accounts.map((a,i)=>`<option value="${i}">${a.name}</option>`).join("");
        document.getElementById("adjT").innerHTML = opts;
        document.getElementById("opTypeSelect").innerHTML = data.types.map(t => `<option>${t}</option>`).join("");
        document.getElementById("histContent").innerHTML = data.history.map(h => `<div class="hist-item"><b>[${h.d}]</b> ${h.m}</div>`).join("");
        document.getElementById("delList").innerHTML = data.accounts.map((a,i)=>`<div style="display:flex; justify-content:space-between; font-size:10px; margin-top:5px;">${a.name} <button onclick="delAcc(${i})" style="background:var(--d); padding:2px 5px; width:auto;">X</button></div>`).join("");
    }
</script>
</body>
</html>
