<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MKA Pro - V6.4 FLEX STOCK</title>
    <style>
        :root { --primary: #0f172a; --danger: #ef4444; --success: #16a34a; --warning: #facc15; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--primary); margin: 0; color: white; padding-bottom: 40px; }
        .container { background: white; color: black; margin: 10px; padding: 15px; border-radius: 15px; }
        input, select, button { padding: 12px; margin: 5px 0; border-radius: 8px; border: 1px solid #cbd5e1; width: 100%; box-sizing: border-box; }
        button { cursor: pointer; background: var(--primary); color: white; font-weight: bold; border: none; }
        .vnc-box { background: linear-gradient(135deg, #1e293b, #0f172a); color: white; padding: 15px; border-radius: 15px; text-align: center; border: 2px solid var(--warning); }
        .vnc-val { font-size: 28px; font-weight: bold; color: var(--warning); }
        .card { background: #f1f5f9; padding: 10px; margin: 8px 0; border-radius: 8px; border-left: 5px solid var(--primary); font-size: 13px; }
        .neg { color: var(--danger) !important; font-weight: bold; } /* Style pour solde nÃ©gatif */
        .hidden { display: none !important; }
        .recharge-box { background: #f0f9ff; border: 2px solid #0ea5e9; padding: 15px; border-radius: 12px; margin-top: 15px; color: black; }
        .label-sm { font-size: 11px; font-weight: bold; color: #64748b; display: block; margin-top: 8px; }
    </style>
</head>
<body>

    <div class="container">
        <div id="appSection" class="hidden">
            <div class="vnc-box">
                <span style="font-size: 10px; opacity: 0.8;">VALEUR NETTE (CASH + STOCKS - DETTES SIM)</span><br>
                <div class="vnc-val" id="totalVNC">0.00 $</div>
                <div style="font-size: 11px;">Taux MarchÃ© : <span id="displayTaux">0</span> FC</div>
            </div>

            <div style="display:flex; justify-content:space-between; margin:15px 0; font-size: 13px;">
                <button onclick="location.reload()" style="background:var(--danger); width:auto; padding:5px 12px;">Quitter</button>
                <div style="text-align:right">
                    <strong>Tiroir Cash :</strong><br>
                    <span id="caisseUSD">0</span> $ | <span id="caisseCDF">0</span> FC
                </div>
            </div>

            <div id="operatorBalances"></div>
            <hr>

            <div id="adminSection" class="hidden">
                <div class="recharge-box">
                    <h3 style="margin:0 0 10px 0; color:#0369a1; font-size:16px;">ðŸ“¥ RÃ‰APPRO / TRANSFERT ENTRE SIM</h3>
                    
                    <label class="label-sm">SIM DESTINATION (ReÃ§oit le stock) :</label>
                    <select id="rechargeOpDest"></select>
                    
                    <div style="display:grid; grid-template-columns: 2fr 1fr; gap:5px;">
                        <input type="number" id="rechargeAmt" placeholder="Montant">
                        <select id="rechargeCur"><option value="USD">USD</option><option value="CDF">CDF</option></select>
                    </div>

                    <label class="label-sm">SOURCE DU PAIEMENT :</label>
                    <select id="rechargeSource" onchange="toggleSource()">
                        <option value="caisse">Cash du Tiroir</option>
                        <option value="sim">Payer avec une autre SIM (Airtel Money, etc.)</option>
                        <option value="externe">Apport Externe / Bonus</option>
                    </select>

                    <div id="sourceSimBox" class="hidden">
                        <label class="label-sm">SIM QUI PAYE (Peut finir en nÃ©gatif) :</label>
                        <select id="rechargeOpSource"></select>
                    </div>

                    <label class="label-sm">TAUX D'ACHAT (Optionnel si 0) :</label>
                    <input type="number" id="rechargePrice" placeholder="Prix d'achat">
                    
                    <button onclick="processRecharge()" style="background:#0ea5e9; margin-top:10px;">VALIDER L'OPÃ‰RATION</button>
                </div>

                <div style="margin-top:20px;">
                    <input type="text" id="newOpName" placeholder="Nom de la nouvelle SIM">
                    <button onclick="addOperator()">+ Ajouter SIM (MÃªme sans stock)</button>
                </div>
            </div>
        </div>

        <div id="loginSection" style="padding:40px 0; text-align:center;">
            <h1>MKA PRO V6.4</h1>
            <input type="password" id="pinInput" placeholder="PIN">
            <button onclick="login()" style="width:100%; padding:15px; background:var(--success)">ACCÃ‰DER</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDSK9sIPu8fvGebZQG9EdHBhlf7nl8Dmzs",
            authDomain: "mka-mobile-money.firebaseapp.com",
            databaseURL: "https://mka-mobile-money-default-rtdb.firebaseio.com",
            projectId: "mka-mobile-money"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let data = { caisse: {USD:0, CDF:0}, operators: [], transactions: [], taux: 2850 };

        onValue(ref(db, 'mka_data'), (snap) => {
            if(snap.val()) {
                data = snap.val();
                if(!data.operators) data.operators = [];
                render();
            }
        });

        const save = () => set(ref(db, 'mka_data'), data);

        window.toggleSource = () => {
            document.getElementById("sourceSimBox").classList.toggle("hidden", document.getElementById("rechargeSource").value !== "sim");
        };

        window.processRecharge = () => {
            const destIdx = document.getElementById("rechargeOpDest").value;
            const amt = parseFloat(document.getElementById("rechargeAmt").value) || 0;
            const cur = document.getElementById("rechargeCur").value;
            const source = document.getElementById("rechargeSource").value;
            const price = parseFloat(document.getElementById("rechargePrice").value) || data.taux;

            if(amt <= 0) return alert("Montant invalide");

            // CrÃ©diter destination
            data.operators[destIdx][cur] = (data.operators[destIdx][cur] || 0) + amt;
            data.operators[destIdx].buyPrice = price;

            // DÃ©biter source
            if(source === "caisse") {
                data.caisse[cur] -= amt;
            } else if(source === "sim") {
                const srcIdx = document.getElementById("rechargeOpSource").value;
                data.operators[srcIdx][cur] = (data.operators[srcIdx][cur] || 0) - amt;
            }

            save();
            alert("Flux enregistrÃ© !");
        };

        window.addOperator = () => {
            const n = document.getElementById("newOpName").value;
            if(n) { 
                // CrÃ©ation d'une SIM vide par dÃ©faut
                data.operators.push({ name: n, USD: 0, CDF: 0, buyPrice: data.taux }); 
                save(); 
                document.getElementById("newOpName").value = "";
            }
        };

        window.login = () => {
            if(document.getElementById("pinInput").value === "1234") {
                document.getElementById("loginSection").classList.add("hidden");
                document.getElementById("appSection").classList.remove("hidden");
                document.getElementById("adminSection").classList.remove("hidden");
                render();
            }
        };

        function render() {
            if(document.getElementById("appSection").classList.contains("hidden")) return;
            document.getElementById("displayTaux").innerText = data.taux;
            document.getElementById("caisseUSD").innerText = (data.caisse.USD || 0).toFixed(2);
            document.getElementById("caisseCDF").innerText = (data.caisse.CDF || 0).toLocaleString();

            let vnc = data.caisse.USD + (data.caisse.CDF / data.taux);
            data.operators.forEach(o => {
                vnc += (o.USD || 0) + ((o.CDF || 0) / (o.buyPrice || data.taux));
            });
            document.getElementById("totalVNC").innerText = vnc.toFixed(2) + " $";

            const opsHtml = data.operators.map((o,i) => `<option value="${i}">${o.name}</option>`).join("");
            document.getElementById("rechargeOpDest").innerHTML = opsHtml;
            document.getElementById("rechargeOpSource").innerHTML = opsHtml;

            document.getElementById("operatorBalances").innerHTML = data.operators.map(o => `
                <div class="card">
                    <b>${o.name}</b>: 
                    <span class="${o.USD < 0 ? 'neg' : ''}">${(o.USD || 0).toFixed(2)}$</span> | 
                    <span class="${o.CDF < 0 ? 'neg' : ''}">${(o.CDF || 0).toLocaleString()}FC</span>
                </div>
            `).join("");
        }
    </script>
</body>
</html>
