<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MKA Pro Business - Syst√®me Hybride Certifi√©</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; margin: 0; color: white; padding-bottom: 50px; }
        .container { background: white; color: black; margin: 10px; padding: 15px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        input, select, button { padding: 12px; margin: 5px 0; border-radius: 8px; border: 1px solid #cbd5e1; width: 100%; box-sizing: border-box; font-size: 15px; }
        button { cursor: pointer; background: #0f172a; color: white; font-weight: bold; border: none; transition: 0.2s; }
        button:active { transform: scale(0.96); opacity: 0.8; }
        .card { background: #f1f5f9; padding: 12px; margin: 8px 0; border-radius: 8px; border-left: 5px solid #0f172a; font-size: 14px; }
        .hidden { display: none !important; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .vnc-box { background: linear-gradient(135deg, #1e293b, #0f172a); color: white; padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 15px; border: 2px solid #facc15; }
        .vnc-val { font-size: 30px; font-weight: bold; color: #facc15; }
        .hybrid-box { background: #fff7ed; border: 1px solid #f97316; padding: 10px; border-radius: 10px; margin: 10px 0; }
        .label-sm { font-size: 11px; font-weight: bold; color: #64748b; text-transform: uppercase; display: block; margin-top: 5px; }
    </style>
</head>
<body>

    <h1 style="text-align:center; padding: 10px;">MKA Pro Business</h1>

    <div class="container">
        <div id="loginSection">
            <h2 style="text-align:center">Acc√®s Syst√®me</h2>
            <input type="password" id="pinInput" placeholder="Code PIN">
            <button onclick="login()" style="width:100%; padding: 15px;">D√âVERROUILLER</button>
        </div>

        <div id="appSection" class="hidden">
            <div class="vnc-box">
                <span style="font-size: 11px; opacity: 0.8;">VALEUR NETTE COMPTABLE (VNC)</span><br>
                <div class="vnc-val" id="totalVNC">0.00 $</div>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin:15px 0;">
                <button onclick="logout()" style="background:#ef4444; width:auto; padding:8px 15px; font-size:12px;">Sortir</button>
                <div style="text-align:right; font-size: 13px;">
                    <strong>Tiroir Cash :</strong><br>
                    <span id="caisseUSD" style="color:#16a34a; font-weight:bold">0</span> $ | <span id="caisseCDF" style="color:#16a34a; font-weight:bold">0</span> FC
                </div>
            </div>

            <div style="text-align: center; margin-bottom: 15px;">
                <span style="background:#facc15; color:black; padding:5px 15px; border-radius:20px; font-weight:bold; font-size:13px;">Taux: 1$ = <span id="displayTaux">0</span> FC</span>
            </div>

            <h3>Balances & Stocks</h3>
            <div id="operatorBalances"></div>

            <hr>
            <h2>Op√©ration (Vente/Retrait)</h2>
            
            <label class="label-sm">1. SIM & TYPE</label>
            <div class="grid-2">
                <select id="operatorSelect"></select>
                <select id="typeSelect"></select>
            </div>

            <label class="label-sm">2. MONTANT BRUT (Sur la SIM)</label>
            <div class="grid-2">
                <input type="number" id="amount" placeholder="Ex: 103">
                <select id="currency"><option value="USD">USD</option><option value="CDF">CDF</option></select>
            </div>

            <div class="hybrid-box">
                <label class="label-sm" style="color:#c2410c;">3. R√âPARTITION SORTIE CAISSE (Optionnel)</label>
                <div class="grid-2">
                    <div>
                        <label style="font-size:10px">Donn√© en USD ($)</label>
                        <input type="number" id="outUSD" value="0">
                    </div>
                    <div>
                        <label style="font-size:10px">Donn√© en CDF (FC)</label>
                        <input type="number" id="outCDF" value="0">
                    </div>
                </div>
                <p style="font-size:9px; color:#9a3412; margin-top:5px;">* Laissez √† 0 pour un paiement simple dans la devise brute.</p>
            </div>

            <input type="text" id="motif" placeholder="Nom du Client / R√©f√©rence">
            <button onclick="addTransaction()" style="background:#16a34a; width:100%; height:50px; margin-top:10px;">VALIDER L'OP√âRATION</button>

            <hr>
            <h3>Journal R√©cent</h3>
            <div id="history"></div>

            <div id="adminSection" class="hidden">
                <div class="admin-box" style="border: 2px solid #ef4444; padding: 15px; border-radius: 12px; margin-top: 20px; background: #fff1f2; color: #991b1b;">
                    <h2 style="margin:0;">üîß Configuration</h2>
                    <div style="background:white; padding:10px; border-radius:8px; margin:10px 0; color:black;">
                        <h4>Taux Global</h4>
                        <input type="number" id="newTaux" placeholder="Taux (ex: 2850)">
                        <button onclick="updateTaux()" style="width:100%">Mettre √† jour</button>
                    </div>
                    <div style="background:white; padding:10px; border-radius:8px; margin:10px 0; color:black;">
                        <h4>Ajouter SIM</h4>
                        <input type="text" id="newOpName" placeholder="Nom SIM">
                        <div class="grid-2"><input type="number" id="initUSD" placeholder="Solde $"><input type="number" id="initCDF" placeholder="Solde FC"></div>
                        <div class="grid-2"><input type="number" id="initStock" placeholder="Stock"><input type="number" id="initPrice" placeholder="Prix Achat $"></div>
                        <button onclick="addOperator()" style="width:100%; background:#b91c1c">Cr√©er SIM</button>
                    </div>
                    <div style="background:white; padding:10px; border-radius:8px; margin:10px 0; color:black;">
                        <h4>Types Op√©rations</h4>
                        <div class="grid-2" style="margin-bottom:5px;">
                            <select id="impO"><option value="0">SIM: 0</option><option value="1">SIM: +</option><option value="-1">SIM: -</option></select>
                            <select id="impS"><option value="0">Stk: 0</option><option value="1">Stk: +</option><option value="-1">Stk: -</option></select>
                        </div>
                        <select id="impC" style="margin-bottom:5px;"><option value="0">Csh: 0</option><option value="1">Csh: +</option><option value="-1">Csh: -</option></select>
                        <input type="text" id="newTypeName" placeholder="Nom (D√©p√¥t, Retrait...)">
                        <button onclick="addType()" style="width:100%; background:#b91c1c">Ajouter Type</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDSK9sIPu8fvGebZQG9EdHBhlf7nl8Dmzs",
            authDomain: "mka-mobile-money.firebaseapp.com",
            databaseURL: "https://mka-mobile-money-default-rtdb.firebaseio.com",
            projectId: "mka-mobile-money"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let data = { caisse: {USD:0, CDF:0}, operators: [], types: [], transactions: [], dettes: [], taux: 2800 };

        onValue(ref(db, 'mka_data'), (snap) => {
            if(snap.val()) {
                data = snap.val();
                if(!data.operators) data.operators = [];
                if(!data.types) data.types = [];
                if(!data.transactions) data.transactions = [];
                render();
            }
        });

        const save = () => set(ref(db, 'mka_data'), data);

        window.addTransaction = () => {
            const opI = document.getElementById("operatorSelect").value;
            const tyI = document.getElementById("typeSelect").value;
            const amtBrut = parseFloat(document.getElementById("amount").value) || 0;
            const cur = document.getElementById("currency").value;
            
            const oUSD = parseFloat(document.getElementById("outUSD").value) || 0;
            const oCDF = parseFloat(document.getElementById("outCDF").value) || 0;

            if(!data.operators[opI] || !data.types[tyI] || amtBrut <= 0) return alert("Donn√©es invalides");

            const op = data.operators[opI];
            const ty = data.types[tyI];

            // 1. IMPACT SIM (Montant brut)
            op[cur] += (amtBrut * ty.impO);
            op.stock += (amtBrut * ty.impS);

            // 2. IMPACT CAISSE (Logique Hybride vs Classique)
            if(oUSD > 0 || oCDF > 0) {
                // Mode Hybride : On retire exactement ce qui a √©t√© saisi manuellement
                data.caisse.USD -= oUSD;
                data.caisse.CDF -= oCDF;
            } else {
                // Mode Classique : Automatique
                data.caisse[cur] += (amtBrut * ty.impC);
            }

            data.transactions.unshift({
                date: new Date().toLocaleString(),
                desc: `${ty.name} ${op.name} (${amtBrut}${cur})`,
                details: (oUSD > 0 || oCDF > 0) ? `Hybride: ${oUSD}$ + ${oCDF}FC` : `Classique`
            });

            save();
            alert("Op√©ration enregistr√©e !");
            // Reset
            document.getElementById("amount").value = "";
            document.getElementById("outUSD").value = 0;
            document.getElementById("outCDF").value = 0;
        };

        window.updateTaux = () => { data.taux = parseFloat(document.getElementById("newTaux").value); save(); alert("Taux OK"); };
        window.addOperator = () => {
            const n = document.getElementById("newOpName").value;
            data.operators.push({ 
                name: n, 
                USD: parseFloat(document.getElementById("initUSD").value)||0, 
                CDF: parseFloat(document.getElementById("initCDF").value)||0, 
                stock: parseFloat(document.getElementById("initStock").value)||0,
                unitPrice: parseFloat(document.getElementById("initPrice").value)||0 
            });
            save(); alert("SIM Cr√©√©e");
        };
        window.addType = () => {
            const n = document.getElementById("newTypeName").value;
            data.types.push({ 
                name: n, 
                impO: parseInt(document.getElementById("impO").value), 
                impS: parseInt(document.getElementById("impS").value), 
                impC: parseInt(document.getElementById("impC").value) 
            });
            save(); alert("Type Cr√©√©");
        };

        window.login = () => {
            const p = document.getElementById("pinInput").value;
            if(p === "1234" || p === "0000") {
                document.getElementById("loginSection").classList.add("hidden");
                document.getElementById("appSection").classList.remove("hidden");
                if(p === "1234") document.getElementById("adminSection").classList.remove("hidden");
                render();
            } else alert("Code PIN Incorrect");
        };

        window.logout = () => location.reload();

        function render() {
            if(document.getElementById("appSection").classList.contains("hidden")) return;
            document.getElementById("caisseUSD").innerText = data.caisse.USD.toLocaleString();
            document.getElementById("caisseCDF").innerText = data.caisse.CDF.toLocaleString();
            document.getElementById("displayTaux").innerText = data.taux;

            let vnc = data.caisse.USD + (data.caisse.CDF / data.taux);
            let opCards = "";
            
            data.operators.forEach((o, i) => {
                const stockVal = o.stock * (o.unitPrice || 0);
                vnc += o.USD + (o.CDF / data.taux) + stockVal;
                opCards += `<div class="card"><b>${o.name}</b>: ${o.USD}$ | ${o.CDF}FC<br><small>Stock: ${o.stock} (P.A: ${o.unitPrice || 0}$)</small></div>`;
            });

            document.getElementById("totalVNC").innerText = vnc.toFixed(2) + " $";
            document.getElementById("operatorBalances").innerHTML = opCards;
            document.getElementById("operatorSelect").innerHTML = data.operators.map((o,i)=>`<option value="${i}">${o.name}</option>`).join("");
            document.getElementById("typeSelect").innerHTML = data.types.map((t,i)=>`<option value="${i}">${t.name}</option>`).join("");
            document.getElementById("history").innerHTML = data.transactions.slice(0,5).map(t => `<div class="card" style="font-size:11px"><b>${t.date}</b>: ${t.desc}<br><i style="color:gray">${t.details || ""}</i></div>`).join("");
        }
    </script>
</body>
</html>
