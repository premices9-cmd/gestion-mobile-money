<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MKA PRO V18.1 ENTREPRISE</title>

<style>
:root { --p:#0f172a; --s:#16a34a; --d:#ef4444; --w:#facc15; --i:#3b82f6; }
body { font-family:Segoe UI; background:var(--p); margin:0; color:white; }
.container { background:white; color:black; margin:10px; padding:15px; border-radius:15px; min-height:95vh; }
input,select,button { padding:10px; margin:5px 0; width:100%; border-radius:8px; }
button { background:var(--p); color:white; font-weight:bold; border:none; cursor:pointer; }
button:hover { opacity:0.9; }
.hidden { display:none; }
.card { background:#f1f5f9; padding:8px; border-radius:8px; margin:5px 0; }
.vnc { background:#0f172a; color:#facc15; padding:15px; border-radius:12px; text-align:center; }
.hist-item { font-size:11px; border-bottom:1px solid #ddd; padding:4px; }
h3 { margin-top:25px; }
</style>
</head>

<body>
<div class="container">

<!-- LOGIN -->
<div id="loginPage">
<h2>MKA PRO V18.1</h2>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Mot de passe">
<button onclick="login()">Connexion</button>
</div>

<!-- MAIN -->
<div id="mainApp" class="hidden">

<div class="vnc">
<div>VALEUR NETTE</div>
<h2 id="vncDisp">0 $</h2>
<div>Caisse: <span id="cashUSD"></span>$ | <span id="cashCDF"></span> FC</div>
</div>

<button onclick="logout()" style="background:var(--d)">D√©connexion</button>

<h3>COMPTES</h3>
<div id="accountList"></div>

<h3>üí± BUREAU DE CHANGE</h3>
<select id="chDir">
<option value="buy">Achat USD</option>
<option value="sell">Vente USD</option>
</select>
<input type="number" id="chAmt" placeholder="Montant USD">
<input type="number" id="chRate" placeholder="Taux">
<button onclick="execChange()">Valider Change</button>

<h3>üèß RETRAIT CLIENT (MIXTE)</h3>
<select id="retAcc"></select>
<input type="number" id="retTotal" placeholder="Montant √† retirer USD">
<input type="number" id="retCashUSD" placeholder="Donner en USD">
<input type="number" id="retCashCDF" placeholder="Donner en CDF">
<button onclick="execRetrait()">Valider Retrait</button>

<h3>üîÑ MOUVEMENTS INTERNES</h3>
<select id="moveType">
<option value="Dette">Paiement Dette</option>
<option value="DepenseCash">D√©pense Cash</option>
<option value="DepenseVirtuelle">D√©pense Virtuelle</option>
<option value="Reappro">R√©approvisionnement</option>
<option value="Transfert">Transfert Interne</option>
</select>
<select id="moveSrc"></select>
<select id="moveDst"></select>
<input type="number" id="moveAmt" placeholder="Montant">
<select id="moveCur">
<option value="USD">USD</option>
<option value="CDF">CDF</option>
</select>
<button onclick="execMoveSecure()">Valider Mouvement</button>

<h3>üìú HISTORIQUE</h3>
<div id="histContent"></div>

<button onclick="exportPDF()">üìÑ Rapport PDF</button>
<button onclick="exportJSON()">üíæ Backup JSON</button>

</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

const firebaseConfig = {
apiKey:"TA_CLE",
authDomain:"TON_DOMAINE.firebaseapp.com",
databaseURL:"TON_URL",
projectId:"TON_PROJECT_ID"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

let data = {
caisse:{USD:0,CDF:0},
accounts:[],
history:[],
taux:2850
};

const val = (id)=>{
const v=parseFloat(document.getElementById(id).value);
return isNaN(v)?0:v;
};

onAuthStateChanged(auth,(user)=>{
if(user){
document.getElementById("loginPage").classList.add("hidden");
document.getElementById("mainApp").classList.remove("hidden");
loadData();
}else{
document.getElementById("loginPage").classList.remove("hidden");
document.getElementById("mainApp").classList.add("hidden");
}
});

window.login = async ()=>{
try{
await signInWithEmailAndPassword(auth,
document.getElementById("email").value,
document.getElementById("password").value);
}catch(e){ alert("Connexion refus√©e"); }
};

window.logout = ()=> signOut(auth);

function loadData(){
onValue(ref(db,"mka_data"),(snap)=>{
if(snap.val()) data=snap.val();
render();
});
}

function saveData(message){
const user=auth.currentUser.email;
data.history.unshift({
d:new Date().toLocaleString("fr-FR"),
m:message,
user
});
if(data.history.length>200) data.history.pop();
set(ref(db,"mka_data"),data);
}

window.execChange = ()=>{
const u=val("chAmt");
const rate=val("chRate")||data.taux;
const c=Math.round(u*rate);
const dir=document.getElementById("chDir").value;

if(u<=0) return alert("Montant invalide");

if(dir==="buy"){
if(data.caisse.CDF<c) return alert("CDF insuffisant");
data.caisse.USD+=u;
data.caisse.CDF-=c;
}else{
if(data.caisse.USD<u) return alert("USD insuffisant");
data.caisse.USD-=u;
data.caisse.CDF+=c;
}

saveData(`CHANGE ${dir} ${u}$`);
};

window.execRetrait = ()=>{
const i=document.getElementById("retAcc").value;
if(!data.accounts[i]) return alert("Compte invalide");

const total=val("retTotal");
const usd=val("retCashUSD");
const cdf=val("retCashCDF");

if(total<=0) return alert("Montant invalide");

const equiv=usd+(cdf/data.taux);
if(equiv>total) return alert("Vous donnez plus que le retrait");

if(data.accounts[i].USD<total)
return alert("Solde virtuel insuffisant");

if(data.caisse.USD<usd || data.caisse.CDF<cdf)
return alert("Caisse insuffisante");

data.accounts[i].USD-=total;
data.caisse.USD-=usd;
data.caisse.CDF-=cdf;

saveData(`RETRAIT ${data.accounts[i].name} -${total}$`);
};

window.execMoveSecure = ()=>{
const type=document.getElementById("moveType").value;
const s=document.getElementById("moveSrc").value;
const d=document.getElementById("moveDst").value;
const amt=val("moveAmt");
const cur=document.getElementById("moveCur").value;

if(amt<=0||s===d) return alert("Op√©ration invalide");

const source=s==="c"?data.caisse:data.accounts[s];
const dest=d==="c"?data.caisse:data.accounts[d];

if(!source||!dest) return alert("Erreur compte");
if(source[cur]<amt) return alert("Solde insuffisant");

source[cur]-=amt;
dest[cur]+=amt;

saveData(`${type}: ${amt} ${cur}`);
};

function render(){
document.getElementById("cashUSD").innerText=data.caisse.USD.toFixed(2);
document.getElementById("cashCDF").innerText=data.caisse.CDF;

let vnc=data.caisse.USD+(data.caisse.CDF/data.taux);

document.getElementById("accountList").innerHTML=
data.accounts.map(a=>{
vnc+=a.USD+(a.CDF/data.taux);
return `<div class="card">${a.name} : ${a.USD}$ | ${a.CDF}F</div>`;
}).join("");

document.getElementById("vncDisp").innerText=vnc.toFixed(2)+" $";

document.getElementById("histContent").innerHTML=
data.history.map(h=>
`<div class="hist-item">[${h.d}] (${h.user}) ${h.m}</div>`
).join("");

const opts=`<option value="c">üí∞ CAISSE</option>`+
data.accounts.map((a,i)=>
`<option value="${i}">${a.name}</option>`).join("");

document.getElementById("moveSrc").innerHTML=opts;
document.getElementById("moveDst").innerHTML=opts;
document.getElementById("retAcc").innerHTML=
data.accounts.map((a,i)=>
`<option value="${i}">${a.name}</option>`).join("");
}

window.exportJSON=()=>{
const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
const a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="mka_backup.json";
a.click();
};
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
function exportPDF(){
const { jsPDF } = window.jspdf;
const doc=new jsPDF();
doc.text("MKA PRO V18.1 RAPPORT",10,10);
let y=20;
document.querySelectorAll(".hist-item").forEach(el=>{
doc.text(el.innerText,10,y);
y+=7;
if(y>280){doc.addPage();y=10;}
});
doc.save("rapport_mka.pdf");
}
</script>

</body>
    </html>
